name: ðŸ” Validate SonarCloud Configuration

on:
  pull_request:
    paths:
      - 'sonar-project.properties'
      - 'backend/pom.xml'
      - 'frontend/package.json'
      - '.github/workflows/ci.yml'
      - '.github/workflows/validate-sonar-config.yml'

jobs:
  validate-config:
    name: Validate SonarCloud Config
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate sonar-project.properties
      run: |
        echo "ðŸ” Validating SonarCloud configuration..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
        REQUIRED_KEYS=(
          "sonar.projectKey"
          "sonar.organization"
          "sonar.sources"
          "sonar.tests"
          "sonar.host.url"
          "sonar.qualitygate.wait"
        )
        
        echo "ðŸ“‹ Checking required configuration keys..."
        MISSING_KEYS=""
        
        for key in "${REQUIRED_KEYS[@]}"; do
          if ! grep -q "^$key=" sonar-project.properties; then
            echo "âŒ Missing required key: $key"
            MISSING_KEYS="$MISSING_KEYS $key"
          else
            echo "âœ… Found: $key"
          fi
        done
        
        if [ -n "$MISSING_KEYS" ]; then
          echo ""
          echo "ðŸš« SonarCloud configuration validation FAILED"
          echo "Missing keys:$MISSING_KEYS"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
        echo ""
        echo "ðŸ“Š Validating configuration values..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ URL SonarCloud
        if ! grep -q "sonar.host.url=https://sonarcloud.io" sonar-project.properties; then
          echo "âŒ sonar.host.url must be set to https://sonarcloud.io"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Quality Gate Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½
        if ! grep -q "sonar.qualitygate.wait=true" sonar-project.properties; then
          echo "âŒ sonar.qualitygate.wait must be set to true"
          exit 1
        fi
        
        echo "âœ… SonarCloud configuration validation passed"

    - name: Validate Maven SonarQube configuration
      run: |
        echo "ðŸ” Validating Maven SonarQube plugin configuration..."
        
        if [ ! -f "backend/pom.xml" ]; then
          echo "âŒ backend/pom.xml not found"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ SonarQube Maven plugin
        if ! grep -q "sonar-maven-plugin" backend/pom.xml; then
          echo "âŒ SonarQube Maven plugin not found in pom.xml"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ JaCoCo plugin
        if ! grep -q "jacoco-maven-plugin" backend/pom.xml; then
          echo "âŒ JaCoCo Maven plugin not found in pom.xml"
          exit 1
        fi
        
        echo "âœ… Maven configuration validation passed"

    - name: Validate Frontend Jest coverage configuration
      run: |
        echo "ðŸ” Validating Frontend Jest coverage configuration..."
        
        if [ ! -f "frontend/package.json" ]; then
          echo "âŒ frontend/package.json not found"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ coverage script
        if ! grep -q "test:coverage" frontend/package.json; then
          echo "âŒ test:coverage script not found in package.json"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Jest coverage configuration
        if ! grep -q "coverageThreshold" frontend/package.json; then
          echo "âŒ Jest coverageThreshold not configured"
          exit 1
        fi
        
        echo "âœ… Frontend configuration validation passed"

    - name: Validate CI/CD Pipeline Integration
      run: |
        echo "ðŸ” Validating CI/CD pipeline SonarCloud integration..."
        
        if [ ! -f ".github/workflows/ci.yml" ]; then
          echo "âŒ CI workflow not found"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ SonarCloud action Ð² CI
        if ! grep -q "SonarSource/sonarcloud-github-action" .github/workflows/ci.yml; then
          echo "âŒ SonarCloud GitHub Action not found in CI workflow"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Quality Gate check
        if ! grep -q "sonarqube-quality-gate-action" .github/workflows/ci.yml; then
          echo "âŒ SonarCloud Quality Gate action not found in CI workflow"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ SONAR_TOKEN
        if ! grep -q "SONAR_TOKEN" .github/workflows/ci.yml; then
          echo "âŒ SONAR_TOKEN not configured in CI workflow"
          exit 1
        fi
        
        echo "âœ… CI/CD pipeline integration validation passed"

    - name: Generate validation report
      run: |
        echo "# ðŸ” SonarCloud Configuration Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| SonarCloud Properties | âœ… Valid | All required keys present |" >> $GITHUB_STEP_SUMMARY
        echo "| Maven Configuration | âœ… Valid | SonarQube + JaCoCo plugins configured |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Configuration | âœ… Valid | Jest coverage thresholds set |" >> $GITHUB_STEP_SUMMARY
        echo "| CI/CD Integration | âœ… Valid | SonarCloud actions configured |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Quality Standards" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Coverage Threshold**: 80% minimum" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality Gate**: Enabled and enforced" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Analysis**: OWASP + SonarCloud vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Blocking**: Pipeline fails on quality gate failure" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Configuration is ready for production use!**"
