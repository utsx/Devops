name: Continuous Deployment - Update Images

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      cluster_id:
        description: 'ID Kubernetes ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: cats7kf12gjptceuiapg)'
        required: true
        default: 'cats7kf12gjptceuiapg'
        type: string

env:
  DOCKER_REGISTRY: 'cr.yandex'

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      deploy-environment: ${{ steps.determine-env.outputs.environment }}
      cluster-id: ${{ steps.determine-env.outputs.cluster-id }}
      should-deploy: ${{ steps.checks.outputs.should-deploy }}
    
    steps:
    - name: Debug deployment trigger
      run: |
        echo "ðŸ” Deployment trigger analysis:"
        echo "Event name: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Source workflow: ${{ github.event.workflow_run.name }}"
        fi
        echo "Actor: ${{ github.actor }}"
    
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine deployment environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          CLUSTER_ID="${{ github.event.inputs.cluster_id }}"
        else
          ENVIRONMENT="staging"
          CLUSTER_ID="cats7kf12gjptceuiapg"
        fi
        echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
        echo "cluster-id=${CLUSTER_ID}" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Target environment: ${ENVIRONMENT}"
        echo "ðŸŽ¯ Target cluster ID: ${CLUSTER_ID}"

    - name: Check required secrets
      id: checks
      run: |
        echo "ðŸ” Checking secrets for image update..."
        
        MISSING_SECRETS=""
        
        # Docker Hub access
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_USERNAME"
        fi
        
        # Yandex Container Registry access (service account key)
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_PASSWORD"
        fi
        
        if [ -z "${{ secrets.YC_REGISTRY_ID }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_REGISTRY_ID"
        fi

        # Kubernetes access (service account key for yc CLI)
        if [ -z "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_SERVICE_ACCOUNT_KEY"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "âŒ Missing required secrets:${MISSING_SECRETS}"
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… All secrets for image update are configured"
        echo "should-deploy=true" >> $GITHUB_OUTPUT

    - name: Update deployment summary
      run: |
        echo "## ðŸš€ Image Update Plan" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ steps.determine-env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Cluster ID | ${{ steps.determine-env.outputs.cluster-id }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð² Kubernetes
  update-images:
    name: Update Docker Images in Kubernetes
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup Yandex Cloud CLI
      run: |
        echo "ðŸ”§ Installing Yandex Cloud CLI..."
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Configure Yandex Cloud CLI
      run: |
        echo "ðŸ”‘ Configuring Yandex Cloud CLI..."
        echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > sa-key.json
        yc config profile create deploy-profile
        yc config set service-account-key sa-key.json
        rm sa-key.json
        echo "âœ… Yandex Cloud CLI configured"

    - name: Configure kubectl
      run: |
        echo "ðŸ”‘ Configuring kubectl for cluster ID ${{ needs.pre-deployment-checks.outputs.cluster-id }}..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ credentials Ð´Ð»Ñ kubectl (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ID ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°)
        yc managed-kubernetes cluster get-credentials ${{ needs.pre-deployment-checks.outputs.cluster-id }} --external --force
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
        kubectl cluster-info
        kubectl get nodes
        
        echo "âœ… kubectl configured successfully"

    - name: Pull and push Docker images
      run: |
        echo "ðŸ³ Pulling from Docker Hub and pushing to Yandex Container Registry..."
        
        # ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Yandex Container Registry
        echo '${{ secrets.DOCKER_PASSWORD }}' | docker login ${{ env.DOCKER_REGISTRY }} -u json_key --password-stdin
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³Ð¸ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
        VERSION="latest"
        REGISTRY_ID="${{ secrets.YC_REGISTRY_ID }}"
        
        # Docker Hub Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        DOCKER_HUB_BACKEND="utsx/devops-backend:latest"
        DOCKER_HUB_FRONTEND="utsx/devops-frontend:latest"
        
        # Yandex Container Registry Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        BACKEND_IMAGE="${{ env.DOCKER_REGISTRY }}/${REGISTRY_ID}/devops-backend:${VERSION}"
        FRONTEND_IMAGE="${{ env.DOCKER_REGISTRY }}/${REGISTRY_ID}/devops-frontend:${VERSION}"
        
        echo "ðŸ“¥ Pulling backend from Docker Hub..."
        docker pull $DOCKER_HUB_BACKEND
        docker tag $DOCKER_HUB_BACKEND $BACKEND_IMAGE
        docker push $BACKEND_IMAGE
        
        echo "ðŸ“¥ Pulling frontend from Docker Hub..."
        docker pull $DOCKER_HUB_FRONTEND
        docker tag $DOCKER_HUB_FRONTEND $FRONTEND_IMAGE
        docker push $FRONTEND_IMAGE
        
        echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_ENV
        echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_ENV
        echo "âœ… Images pulled from Docker Hub and pushed to Yandex CR"

    - name: Update Kubernetes deployments
      run: |
        echo "ðŸš€ Updating Kubernetes deployments..."
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ backend deployment
        kubectl set image deployment/devops-backend-deployment devops-backend=${{ env.BACKEND_IMAGE }}
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ frontend deployment  
        kubectl set image deployment/devops-frontend-deployment devops-frontend=${{ env.FRONTEND_IMAGE }}
        
        # ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ rollout
        echo "â³ Waiting for deployments to rollout..."
        kubectl rollout status deployment/devops-backend-deployment --timeout=600s
        kubectl rollout status deployment/devops-frontend-deployment --timeout=600s
        
        echo "âœ… Deployments updated successfully"

    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment status..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¾Ð²
        kubectl get pods -l app=devops-backend
        kubectl get pods -l app=devops-frontend
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
        kubectl get services
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ LoadBalancer IP (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
        FRONTEND_IP=$(kubectl get service devops-frontend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
        
        echo "ðŸŒ Frontend LoadBalancer IP: ${FRONTEND_IP}"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð´Ð¾Ð²
        kubectl wait --for=condition=ready pod -l app=devops-backend --timeout=300s
        kubectl wait --for=condition=ready pod -l app=devops-frontend --timeout=300s
        
        echo "âœ… All pods are ready"

    - name: Health checks
      run: |
        echo "ðŸ¥ Running health checks..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint Ð±ÑÐºÐµÐ½Ð´Ð° Ñ‡ÐµÑ€ÐµÐ· port-forward
        kubectl port-forward deployment/devops-backend-deployment 8080:8080 &
        PORT_FORWARD_PID=$!
        
        # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
        sleep 5
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint
        if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
          echo "âœ… Backend health check passed"
        else
          echo "âš ï¸ Backend health check failed"
        fi
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ port-forward
        kill $PORT_FORWARD_PID 2>/dev/null || true
        
        echo "âœ… Health checks completed"

    - name: Update deployment summary
      if: always()
      run: |
        echo "## ðŸ“Š Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð´ÐµÐ¿Ð»Ð¾Ð¹Ð¼ÐµÐ½Ñ‚Ð°
        if [ "${{ job.status }}" = "success" ]; then
          echo "### âœ… Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Status: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cluster ID**: ${{ needs.pre-deployment-checks.outputs.cluster-id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Image**: \`${{ env.BACKEND_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Image**: \`${{ env.FRONTEND_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        
        # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¾Ð²
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸƒâ€â™‚ï¸ Pod Status" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        kubectl get pods -l "app in (devops-backend,devops-frontend)" || echo "Failed to get pod status" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        docker system prune -f || true
        echo "âœ… Cleanup completed"
