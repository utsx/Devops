name: Continuous Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð´Ð»Ñ latest)'
        required: false
        type: string

env:
  DOCKER_REGISTRY: 'docker.io'
  DOCKER_BUILDKIT: 1

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      deploy-environment: ${{ steps.determine-env.outputs.environment }}
      deploy-version: ${{ steps.determine-version.outputs.version }}
      should-deploy: ${{ steps.checks.outputs.should-deploy }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine deployment environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        else
          # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² staging Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸
          ENVIRONMENT="staging"
        fi
        echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Target environment: ${ENVIRONMENT}"

    - name: Determine deployment version
      id: determine-version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SHA ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ð¹
          VERSION="latest"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Deploy version: ${VERSION}"

    - name: Run pre-deployment checks
      id: checks
      run: |
        echo "ðŸ” Running pre-deployment checks..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
        MISSING_SECRETS=""
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_USERNAME"
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_PASSWORD"
        fi
        
        if [ -z "${{ secrets.KUBE_CONFIG }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} KUBE_CONFIG"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "âŒ Missing required secrets:${MISSING_SECRETS}"
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… All pre-deployment checks passed"
        echo "should-deploy=true" >> $GITHUB_OUTPUT

    - name: Update deployment summary
      run: |
        echo "## ðŸš€ Deployment Plan" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | \`${{ steps.determine-env.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Version | \`${{ steps.determine-version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² Kubernetes
  deploy-to-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
        kubectl config current-context
        kubectl get nodes

    - name: Login to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Prepare Kubernetes manifests
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ð¾Ð²
        mkdir -p k8s-deploy
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ñ‹
        cp terraform/k8s-manifests.yaml k8s-deploy/
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð² Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ð°Ñ…
        VERSION="${{ needs.pre-deployment-checks.outputs.deploy-version }}"
        DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
        
        sed -i "s|utsx/devops-backend:latest|${DOCKER_USERNAME}/devops-backend:${VERSION}|g" k8s-deploy/k8s-manifests.yaml
        sed -i "s|utsx/devops-frontend:latest|${DOCKER_USERNAME}/devops-frontend:${VERSION}|g" k8s-deploy/k8s-manifests.yaml
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
        DEPLOYMENT_ID="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
        echo "DEPLOYMENT_ID=${DEPLOYMENT_ID}" >> $GITHUB_ENV
        
        echo "ðŸ“¦ Prepared manifests for deployment ${DEPLOYMENT_ID}"

    - name: Deploy to Kubernetes
      run: |
        export KUBECONFIG=kubeconfig
        
        echo "ðŸš€ Deploying to Kubernetes cluster..."
        
        # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ñ‹
        kubectl apply -f k8s-deploy/k8s-manifests.yaml
        
        echo "âœ… Manifests applied successfully"

    - name: Wait for deployment rollout
      run: |
        export KUBECONFIG=kubeconfig
        
        echo "â³ Waiting for deployments to complete..."
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ backend
        kubectl rollout status deployment/devops-backend -n devops-app --timeout=600s
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ frontend
        kubectl rollout status deployment/devops-frontend -n devops-app --timeout=600s
        
        echo "âœ… All deployments completed successfully"

    - name: Verify deployment
      run: |
        export KUBECONFIG=kubeconfig
        
        echo "ðŸ” Verifying deployment..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¾Ð²
        kubectl get pods -n devops-app -o wide
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
        kubectl get services -n devops-app
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP
        EXTERNAL_IP=$(kubectl get service devops-frontend-service -n devops-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
        echo "EXTERNAL_IP=${EXTERNAL_IP}" >> $GITHUB_ENV
        
        echo "âœ… Deployment verification completed"

    - name: Update deployment summary
      run: |
        export KUBECONFIG=kubeconfig
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Deployment Completed" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        
        # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ backend
        BACKEND_STATUS=$(kubectl get deployment devops-backend -n devops-app -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
        if [ "$BACKEND_STATUS" = "True" ]; then
          echo "| Backend | âœ… Running | Deployment successful |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Backend | âŒ Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ frontend
        FRONTEND_STATUS=$(kubectl get deployment devops-frontend -n devops-app -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
        if [ "$FRONTEND_STATUS" = "True" ]; then
          echo "| Frontend | âœ… Running | Deployment successful |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Frontend | âŒ Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        DB_STATUS=$(kubectl get deployment postgres -n devops-app -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
        if [ "$DB_STATUS" = "True" ]; then
          echo "| Database | âœ… Running | PostgreSQL ready |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Database | âŒ Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Access Information" >> $GITHUB_STEP_SUMMARY
        if [ "${{ env.EXTERNAL_IP }}" != "pending" ] && [ -n "${{ env.EXTERNAL_IP }}" ]; then
          echo "- **Application URL**: http://${{ env.EXTERNAL_IP }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Application URL**: External IP is being assigned..." >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Environment**: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.pre-deployment-checks.outputs.deploy-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment ID**: ${{ env.DEPLOYMENT_ID }}" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -f kubeconfig
        rm -rf k8s-deploy

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ… Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
  notify-deployment-result:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-to-kubernetes]
    if: always() && needs.pre-deployment-checks.outputs.should-deploy == 'true'
    
    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [ "${{ needs.deploy-to-kubernetes.result }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=âœ… Deployment completed successfully" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Deployment failed" >> $GITHUB_OUTPUT
        fi

    - name: Create deployment summary
      run: |
        echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.pre-deployment-checks.outputs.deploy-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.status.outputs.status }}" = "success" ]; then
          echo "ðŸŽ‰ **The application has been successfully deployed and is ready for use!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ”§ **Please check the deployment logs and fix any issues before retrying.**" >> $GITHUB_STEP_SUMMARY
        fi