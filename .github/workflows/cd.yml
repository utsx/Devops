name: Continuous Deployment - Yandex Cloud

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  DOCKER_REGISTRY: 'cr.yandex'
  TF_VERSION: '1.6.0'
  YC_VERSION: '0.112.0'

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      deploy-environment: ${{ steps.determine-env.outputs.environment }}
      should-deploy: ${{ steps.checks.outputs.should-deploy }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine deployment environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        else
          ENVIRONMENT="staging"
        fi
        echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Target environment: ${ENVIRONMENT}"

    - name: Check required secrets
      id: checks
      run: |
        echo "ðŸ” Checking Yandex Cloud secrets..."
        
        MISSING_SECRETS=""
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_USERNAME"
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} DOCKER_PASSWORD"
        fi
        
        if [ -z "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_SERVICE_ACCOUNT_KEY"
        fi
        
        if [ -z "${{ secrets.YC_CLOUD_ID }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_CLOUD_ID"
        fi
        
        if [ -z "${{ secrets.YC_FOLDER_ID }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_FOLDER_ID"
        fi
        
        if [ -z "${{ secrets.YC_REGISTRY_ID }}" ]; then
          MISSING_SECRETS="${MISSING_SECRETS} YC_REGISTRY_ID"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "âŒ Missing required secrets:${MISSING_SECRETS}"
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… All pre-deployment checks passed"
        echo "should-deploy=true" >> $GITHUB_OUTPUT

    - name: Update deployment summary
      run: |
        echo "## ðŸš€ Deployment Plan" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Cloud Provider | Yandex Cloud |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | \`${{ steps.determine-env.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² Yandex Cloud
  deploy-to-yandex-cloud:
    name: Deploy to Yandex Cloud
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Setup Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Configure Yandex Cloud CLI
      run: |
        echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > sa-key.json
        yc config profile create deploy-profile
        yc config set service-account-key sa-key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        rm sa-key.json

    - name: Deploy infrastructure with Terraform
      working-directory: terraform
      run: |
        echo "ðŸ—ï¸ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹..."
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Terraform
        terraform init
        
        # ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ
        terraform plan -var="environment=${{ needs.pre-deployment-checks.outputs.deploy-environment }}"
        terraform apply -auto-approve -var="environment=${{ needs.pre-deployment-checks.outputs.deploy-environment }}"
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°
        CLUSTER_NAME=$(terraform output -raw cluster_name)
        echo "CLUSTER_NAME=${CLUSTER_NAME}" >> $GITHUB_ENV
        echo "âœ… Infrastructure deployed: $CLUSTER_NAME"

    - name: Configure kubectl
      run: |
        echo "ðŸ”‘ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° kubectl..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ credentials Ð´Ð»Ñ kubectl
        yc managed-kubernetes cluster get-credentials ${{ env.CLUSTER_NAME }} --external --force
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
        kubectl cluster-info
        kubectl get nodes
        
        # Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑƒÐ·Ð»Ð¾Ð²
        kubectl wait --for=condition=Ready nodes --all --timeout=300s

    - name: Pull and push Docker images
      run: |
        echo "ðŸ³ Pulling from Docker Hub and pushing to Yandex Container Registry..."
        
        # ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Yandex Container Registry
        echo '${{ secrets.DOCKER_PASSWORD }}' | docker login ${{ env.DOCKER_REGISTRY }} -u json_key --password-stdin
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³Ð¸ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
        VERSION="latest"
        REGISTRY_ID="${{ secrets.YC_REGISTRY_ID }}"
        
        # Docker Hub Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        DOCKER_HUB_BACKEND="utsx/devops-backend:latest"
        DOCKER_HUB_FRONTEND="utsx/devops-frontend:latest"
        
        # Yandex Container Registry Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        BACKEND_IMAGE="${{ env.DOCKER_REGISTRY }}/${REGISTRY_ID}/devops-backend:${VERSION}"
        FRONTEND_IMAGE="${{ env.DOCKER_REGISTRY }}/${REGISTRY_ID}/devops-frontend:${VERSION}"
        
        echo "ðŸ“¥ Pulling backend from Docker Hub..."
        docker pull $DOCKER_HUB_BACKEND
        docker tag $DOCKER_HUB_BACKEND $BACKEND_IMAGE
        docker push $BACKEND_IMAGE
        
        echo "ðŸ“¥ Pulling frontend from Docker Hub..."
        docker pull $DOCKER_HUB_FRONTEND
        docker tag $DOCKER_HUB_FRONTEND $FRONTEND_IMAGE
        docker push $FRONTEND_IMAGE
        
        echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_ENV
        echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_ENV
        echo "âœ… Images pulled from Docker Hub and pushed to Yandex CR"

    - name: Deploy to Kubernetes
      working-directory: terraform
      run: |
        echo "ðŸš€ Deploying to Kubernetes..."
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ñ‹ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼Ð¸
        sed -i "s|utsx/devops-backend:latest|${{ env.BACKEND_IMAGE }}|g" k8s-manifests.yaml
        sed -i "s|utsx/devops-frontend:latest|${{ env.FRONTEND_IMAGE }}|g" k8s-manifests.yaml
        
        # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ namespace Ð¸ PostgreSQL ÑÐ½Ð°Ñ‡Ð°Ð»Ð°
        echo "ðŸ—„ï¸ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ PostgreSQL..."
        kubectl apply -f k8s-manifests.yaml --selector="app!=devops-backend,app!=devops-frontend"
        
        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ PostgreSQL
        kubectl wait --for=condition=available --timeout=300s deployment/postgres -n devops-app
        
        # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        echo "ðŸ“± Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹..."
        kubectl apply -f k8s-manifests.yaml
        
        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
        kubectl wait --for=condition=available --timeout=300s deployment/devops-backend -n devops-app
        kubectl wait --for=condition=available --timeout=300s deployment/devops-frontend -n devops-app

    - name: Health checks
      run: |
        echo "ðŸ¥ Running health checks..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¾Ð²
        kubectl get pods -n devops-app
        kubectl get services -n devops-app
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ NodePort Ð¸ IP
        NODE_PORT=$(kubectl get services -n devops-app devops-frontend-service -o jsonpath='{.spec.ports[0].nodePort}')
        EXTERNAL_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
        
        if [ -n "$EXTERNAL_IP" ] && [ -n "$NODE_PORT" ]; then
          APP_URL="http://${EXTERNAL_IP}:${NODE_PORT}"
          echo "ðŸŒ Application URL: $APP_URL"
          
          # ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ health checks
          sleep 30
          
          echo "ðŸ” Testing frontend..."
          for i in {1..5}; do
            if curl -s -o /dev/null -w "%{http_code}" "$APP_URL" | grep -q "200\|301\|302"; then
              echo "âœ… Frontend health check passed (attempt $i)"
              break
            else
              echo "â³ Frontend not ready yet (attempt $i/5)"
              if [ $i -eq 5 ]; then
                echo "âŒ Frontend health check failed"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API
          echo "ðŸ” Testing backend API..."
          API_URL="$APP_URL/api/actuator/health"
          if curl -s -f "$API_URL" | grep -q "UP"; then
            echo "âœ… Backend API health check passed"
          else
            echo "âš ï¸ Backend API health check failed, but continuing..."
          fi
          
          echo "APP_URL=${APP_URL}" >> $GITHUB_ENV
        else
          echo "âš ï¸ Cannot determine external access URL"
          echo "Node Port: $NODE_PORT"
          echo "External IP: $EXTERNAL_IP"
        fi

    - name: Update deployment summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Yandex Cloud Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.APP_URL }}" ]; then
            echo "ðŸŒ **Application URL**: ${{ env.APP_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **API Health**: ${{ env.APP_URL }}/api/actuator/health" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Cloud Provider**: Yandex Cloud" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.pre-deployment-checks.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cluster**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: Yandex Container Registry" >> $GITHUB_STEP_SUMMARY
        echo "- **Images**: Pulled from Docker Hub (utsx/devops-backend, utsx/devops-frontend)" >> $GITHUB_STEP_SUMMARY
        echo "- **Kubernetes**: Applications deployed and verified" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Useful Commands" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Check pods status" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get pods -n devops-app" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Check backend logs" >> $GITHUB_STEP_SUMMARY
        echo "kubectl logs -f deployment/devops-backend -n devops-app" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Check frontend logs" >> $GITHUB_STEP_SUMMARY
        echo "kubectl logs -f deployment/devops-frontend -n devops-app" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -f sa-key.json