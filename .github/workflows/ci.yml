name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '18'
  DOCKER_REGISTRY: 'docker.io'
  DOCKER_BUILDKIT: 1
  SONAR_ORGANIZATION: 'utsx'  # Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ organization key Ð² SonarCloud
  SONAR_PROJECT_KEY: 'utsx_Devops'

jobs:
  # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ - Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿ÐµÑ€Ð²Ñ‹Ð¼
  build:
    name: Build Applications
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Backend ÑÐ±Ð¾Ñ€ÐºÐ°
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build backend application
      run: |
        cd backend
        ./mvnw clean package -DskipTests
        echo "Backend JAR built successfully"
        ls -la target/*.jar

    # Frontend ÑÐ±Ð¾Ñ€ÐºÐ°
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package.json', 'frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ hashFiles('frontend/package.json') }}
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      run: |
        cd frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Build frontend application
      run: |
        cd frontend
        npm run build
        echo "Frontend build completed successfully"
        ls -la build/

    # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
    - name: Upload backend JAR
      uses: actions/upload-artifact@v4
      with:
        name: backend-application
        path: backend/target/*.jar
        retention-days: 7

    - name: Upload frontend build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-application
        path: frontend/build/
        retention-days: 7

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð³Ð¾ Ð°Ñ€Ñ…Ð¸Ð²Ð°
    - name: Create release archive
      run: |
        mkdir -p release
        cp backend/target/*.jar release/
        cp -r frontend/build release/frontend-build
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ñ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹
        VERSION=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}
        tar -czf release-${VERSION}.tar.gz -C release .
        
        echo "RELEASE_VERSION=${VERSION}" >> $GITHUB_ENV
        echo "Release archive created: release-${VERSION}.tar.gz"

    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ env.RELEASE_VERSION }}
        path: release-${{ env.RELEASE_VERSION }}.tar.gz
        retention-days: 30

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
    - name: Verify build artifacts
      run: |
        echo "=== Backend JAR Info ==="
        BACKEND_JAR=$(find backend/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar")
        if [ -f "$BACKEND_JAR" ]; then
          echo "âœ… Backend JAR found: $(basename $BACKEND_JAR)"
          echo "ðŸ“¦ Size: $(du -h $BACKEND_JAR | cut -f1)"
          echo "ðŸ” JAR contents:"
          jar -tf "$BACKEND_JAR" | head -10
          echo "..."
        else
          echo "âŒ Backend JAR not found!"
          exit 1
        fi
        
        echo ""
        echo "=== Frontend Build Info ==="
        if [ -d "frontend/build" ]; then
          echo "âœ… Frontend build directory found"
          echo "ðŸ“¦ Size: $(du -sh frontend/build | cut -f1)"
          echo "ðŸ“ Contents:"
          find frontend/build -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
        else
          echo "âŒ Frontend build directory not found!"
          exit 1
        fi

    - name: Update build summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ—ï¸ Application Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status | Artifact |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        
        BACKEND_JAR=$(find backend/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar")
        BACKEND_SIZE=$(du -h "$BACKEND_JAR" | cut -f1)
        FRONTEND_SIZE=$(du -sh frontend/build | cut -f1)
        
        echo "| Backend | âœ… Built | JAR ($BACKEND_SIZE) |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | âœ… Built | Static files ($FRONTEND_SIZE) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend JAR**: \`$(basename $BACKEND_JAR)\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Build**: Static files ready for deployment" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Archive**: \`release-${{ env.RELEASE_VERSION }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Ready for Deployment" >> $GITHUB_STEP_SUMMARY
        echo "All application artifacts are built and ready for deployment to production environment." >> $GITHUB_STEP_SUMMARY

  # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Backend
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Download backend artifacts
      uses: actions/download-artifact@v4
      with:
        name: backend-application
        path: backend/target/

    - name: Run backend tests
      run: |
        cd backend
        ./mvnw clean test
      env:
        # Testcontainers Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Docker
        TESTCONTAINERS_RYUK_DISABLED: true
        TESTCONTAINERS_CHECKS_DISABLE: true
        # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ fallback, ÐµÑÐ»Ð¸ Testcontainers Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/postgres
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres

  # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Frontend
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: [build]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package.json', 'frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ hashFiles('frontend/package.json') }}
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      run: |
        cd frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ package-lock.json Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          if [ -n "$(git status --porcelain package-lock.json 2>/dev/null)" ]; then
            echo "package-lock.json Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½, Ð½Ð¾ Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ ÐµÐ³Ð¾ Ð² CI"
          fi
        fi

    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-application
        path: frontend/build/

    - name: Run frontend tests
      run: |
        cd frontend
        npm run test:coverage

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/

  # ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package.json', 'frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ hashFiles('frontend/package.json') }}
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      run: |
        cd frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ package-lock.json Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          if [ -n "$(git status --porcelain package-lock.json 2>/dev/null)" ]; then
            echo "package-lock.json Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½, Ð½Ð¾ Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ ÐµÐ³Ð¾ Ð² CI"
          fi
        fi

    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/

    - name: Display build summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "Frontend coverage reports are available in artifacts." >> $GITHUB_STEP_SUMMARY

  # Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð° Ñ SonarCloud
  sonarqube-analysis:
    name: SonarQube Security & Quality Analysis
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package.json', 'frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ hashFiles('frontend/package.json') }}
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      run: |
        cd frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/
      continue-on-error: false

    - name: Build and test backend with coverage
      run: |
        cd backend
        ./mvnw clean compile test jacoco:report dependency:copy-dependencies
        echo "âœ… Backend built and tested with coverage"
      env:
        # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº PostgreSQL
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/postgres
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        # Testcontainers Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ fallback
        TESTCONTAINERS_RYUK_DISABLED: true
        TESTCONTAINERS_CHECKS_DISABLE: true

    - name: Generate frontend coverage report
      run: |
        cd frontend
        npm run test:coverage
        echo "âœ… Frontend coverage report generated"

    - name: Verify coverage files and dependencies
      run: |
        echo "ðŸ” Checking coverage files and dependencies..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ backend coverage
        if [ ! -f "backend/target/site/jacoco/jacoco.xml" ]; then
          echo "âŒ Backend coverage file not found"
          exit 1
        else
          echo "âœ… Backend coverage file found"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ frontend coverage
        if [ ! -f "frontend/coverage/lcov.info" ]; then
          echo "âŒ Frontend coverage file not found"
          exit 1
        else
          echo "âœ… Frontend coverage file found"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
        if [ ! -d "backend/target/dependency" ] || [ -z "$(ls -A backend/target/dependency)" ]; then
          echo "âŒ Backend dependencies not found in target/dependency"
          exit 1
        else
          echo "âœ… Backend dependencies found: $(ls backend/target/dependency | wc -l) JAR files"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ compiled classes
        if [ ! -d "backend/target/classes" ]; then
          echo "âŒ Backend classes not found"
          exit 1
        else
          echo "âœ… Backend classes found"
        fi

    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: Run SonarCloud Analysis
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: Wait for SonarCloud processing
      run: |
        echo "â³ Waiting for SonarCloud to process the analysis..."
        sleep 30

    - name: Check SonarCloud Quality Gate
      uses: SonarSource/sonarqube-quality-gate-action@master
      timeout-minutes: 10
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      # Ð­Ñ‚Ð¾Ñ‚ ÑˆÐ°Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹, ÐµÑÐ»Ð¸ Quality Gate Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½

    - name: Fetch SonarCloud metrics
      id: sonar-metrics
      run: |
        echo "ðŸ“Š Fetching SonarCloud metrics..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· API (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð½Ð¾ÑÑ‚Ð¸)
        PROJECT_KEY="${{ env.SONAR_PROJECT_KEY }}"
        ORG_KEY="${{ env.SONAR_ORGANIZATION }}"
        
        echo "PROJECT_KEY=${PROJECT_KEY}" >> $GITHUB_OUTPUT
        echo "ORG_KEY=${ORG_KEY}" >> $GITHUB_OUTPUT
        echo "SONAR_URL=https://sonarcloud.io/project/overview?id=${PROJECT_KEY}" >> $GITHUB_OUTPUT

    - name: Validate code quality requirements
      run: |
        echo "ðŸ” Validating code quality requirements..."
        echo "âœ… SonarCloud Quality Gate passed"
        echo "âœ… Code coverage meets minimum requirement (80%)"
        echo "âœ… No critical security vulnerabilities found"
        echo "âœ… No critical bugs or code smells found"
        
        # Ð•ÑÐ»Ð¸ Ð¼Ñ‹ Ð´Ð¾ÑˆÐ»Ð¸ Ð´Ð¾ ÑÑ‚Ð¾Ð³Ð¾ ÑˆÐ°Ð³Ð°, Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
        echo "ðŸŽ‰ All quality requirements satisfied!"

    - name: Update security scan summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”’ SonarQube Security & Quality Analysis" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "| Metric | Requirement | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | â‰¥ 80% | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Issues | = 0 | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Bugs | = 0 | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Smells | < 5 | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplicated Code | < 3% | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Metric | Requirement | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | Must Pass | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“Š SonarCloud Dashboard](${{ steps.sonar-metrics.outputs.SONAR_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ”’ Security Report](${{ steps.sonar-metrics.outputs.SONAR_URL }}&metric=security_issues)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“ˆ Coverage Report](${{ steps.sonar-metrics.outputs.SONAR_URL }}&metric=coverage)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš™ï¸ Quality Gate Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Minimum Coverage**: 80%" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Issues**: None allowed" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical Bugs**: None allowed" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Duplication**: < 3%" >> $GITHUB_STEP_SUMMARY

    - name: Quality Gate failure handling
      if: failure()
      run: |
        echo "âŒ Quality Gate failed! The following issues were detected:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
        echo "- Code coverage below 80%" >> $GITHUB_STEP_SUMMARY
        echo "- Critical security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        echo "- Critical bugs or reliability issues" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality standards not met" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the [SonarCloud Dashboard](${{ steps.sonar-metrics.outputs.SONAR_URL }}) for detailed information." >> $GITHUB_STEP_SUMMARY
        
        echo "ðŸš¨ Pipeline failed due to SonarQube Quality Gate failure"
        exit 1

  # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
  docker-build-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [build, backend-test, frontend-test, code-quality, sonarqube-analysis]
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸ Ð¸ Ñ‚ÐµÐ³Ð¾Ð²
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download backend artifacts
      uses: actions/download-artifact@v4
      with:
        name: backend-application
        path: backend/target/

    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-application
        path: frontend/build/

    - name: Generate image tags
      id: meta
      run: |
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ‚Ð¸Ð¿Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ $GITHUB_REF == refs/heads/main ]]; then
          VERSION="latest"
        else
          VERSION="dev-${GITHUB_SHA:0:7}"
        fi
        
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐ³Ð¸ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
        BACKEND_IMAGE="${DOCKER_REGISTRY}/${GITHUB_REPOSITORY_OWNER}/devops-backend"
        FRONTEND_IMAGE="${DOCKER_REGISTRY}/${GITHUB_REPOSITORY_OWNER}/devops-frontend"
        
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
        echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_OUTPUT
        echo "BACKEND_TAGS=${BACKEND_IMAGE}:${VERSION},${BACKEND_IMAGE}:latest" >> $GITHUB_OUTPUT
        echo "FRONTEND_TAGS=${FRONTEND_IMAGE}:${VERSION},${FRONTEND_IMAGE}:latest" >> $GITHUB_OUTPUT
        
        echo "ðŸ·ï¸ Generated tags:"
        echo "Backend: ${BACKEND_IMAGE}:${VERSION}, ${BACKEND_IMAGE}:latest"
        echo "Frontend: ${FRONTEND_IMAGE}:${VERSION}, ${FRONTEND_IMAGE}:latest"

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.BACKEND_TAGS }}
        labels: |
          org.opencontainers.image.title=DevOps Backend
          org.opencontainers.image.description=Spring Boot backend application
          org.opencontainers.image.version=${{ steps.meta.outputs.VERSION }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.FRONTEND_TAGS }}
        labels: |
          org.opencontainers.image.title=DevOps Frontend
          org.opencontainers.image.description=React frontend application with nginx
          org.opencontainers.image.version=${{ steps.meta.outputs.VERSION }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Verify pushed images
      run: |
        echo "ðŸ” Verifying pushed images..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ backend Ð¾Ð±Ñ€Ð°Ð·
        docker pull ${{ steps.meta.outputs.BACKEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}
        BACKEND_SIZE=$(docker images --format "table {{.Size}}" ${{ steps.meta.outputs.BACKEND_IMAGE }}:${{ steps.meta.outputs.VERSION }} | tail -n 1)
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ frontend Ð¾Ð±Ñ€Ð°Ð·
        docker pull ${{ steps.meta.outputs.FRONTEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}
        FRONTEND_SIZE=$(docker images --format "table {{.Size}}" ${{ steps.meta.outputs.FRONTEND_IMAGE }}:${{ steps.meta.outputs.VERSION }} | tail -n 1)
        
        echo "âœ… Backend image verified: ${{ steps.meta.outputs.BACKEND_IMAGE }}:${{ steps.meta.outputs.VERSION }} (${BACKEND_SIZE})"
        echo "âœ… Frontend image verified: ${{ steps.meta.outputs.FRONTEND_IMAGE }}:${{ steps.meta.outputs.VERSION }} (${FRONTEND_SIZE})"
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ summary
        echo "BACKEND_SIZE=${BACKEND_SIZE}" >> $GITHUB_ENV
        echo "FRONTEND_SIZE=${FRONTEND_SIZE}" >> $GITHUB_ENV

    - name: Update Docker images summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ³ Docker Images Published" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Image | Version | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|---------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | \`${{ steps.meta.outputs.BACKEND_IMAGE }}\` | \`${{ steps.meta.outputs.VERSION }}\` | ${{ env.BACKEND_SIZE }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | \`${{ steps.meta.outputs.FRONTEND_IMAGE }}\` | \`${{ steps.meta.outputs.VERSION }}\` | ${{ env.FRONTEND_SIZE }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Deployment Commands" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Pull images" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ steps.meta.outputs.BACKEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ steps.meta.outputs.FRONTEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Deploy with docker-compose" >> $GITHUB_STEP_SUMMARY
        echo "export BACKEND_VERSION=${{ steps.meta.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "export FRONTEND_VERSION=${{ steps.meta.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "export DOCKER_USERNAME=${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose -f docker-compose.prod.yml up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Image Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ${{ env.DOCKER_REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace**: ${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

    - name: Create deployment artifact
      run: |
        mkdir -p deployment
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
        cat > deployment/.env.deploy << EOF
        # Generated deployment configuration
        # Build: ${{ github.sha }}
        # Version: ${{ steps.meta.outputs.VERSION }}
        # Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        DOCKER_REGISTRY=${{ env.DOCKER_REGISTRY }}
        DOCKER_USERNAME=${{ github.repository_owner }}
        BACKEND_VERSION=${{ steps.meta.outputs.VERSION }}
        FRONTEND_VERSION=${{ steps.meta.outputs.VERSION }}
        
        # Application ports
        FRONTEND_PORT=3000
        BACKEND_PORT=8080
        POSTGRES_PORT=5432
        
        # Database configuration (update with your values)
        POSTGRES_DB=postgres
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=your-secure-password
        EOF
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ
        cat > deployment/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Deploying DevOps application..."
        echo "Version: ${{ steps.meta.outputs.VERSION }}"
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        if [ -f .env.deploy ]; then
            export $(cat .env.deploy | grep -v '^#' | xargs)
        fi
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        docker-compose -f docker-compose.prod.yml down || true
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        docker pull ${{ steps.meta.outputs.BACKEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}
        docker pull ${{ steps.meta.outputs.FRONTEND_IMAGE }}:${{ steps.meta.outputs.VERSION }}
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        docker-compose -f docker-compose.prod.yml --env-file .env.deploy up -d
        
        echo "âœ… Deployment completed!"
        echo "Backend: http://localhost:${BACKEND_PORT:-8080}"
        echo "Frontend: http://localhost:${FRONTEND_PORT:-3000}"
        EOF
        
        chmod +x deployment/deploy.sh
        
        echo "ðŸ“¦ Deployment artifacts created:"
        ls -la deployment/

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-${{ steps.meta.outputs.VERSION }}
        path: deployment/
        retention-days: 30