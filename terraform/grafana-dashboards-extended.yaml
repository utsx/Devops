---
# Расширенные дашборды Grafana для детального мониторинга
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-extended
  namespace: monitoring
  labels:
    app: grafana
    component: dashboards-extended
data:
  pod-level-monitoring.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Pod-Level Detailed Monitoring",
        "tags": ["kubernetes", "pods", "detailed"],
        "timezone": "browser",
        "templating": {
          "list": [
            {
              "name": "namespace",
              "type": "query",
              "query": "label_values(kube_pod_info, namespace)",
              "current": {
                "value": "devops-app"
              }
            },
            {
              "name": "pod",
              "type": "query",
              "query": "label_values(kube_pod_info{namespace=\"$namespace\"}, pod)",
              "current": {
                "value": "All"
              },
              "includeAll": true
            }
          ]
        },
        "panels": [
          {
            "id": 1,
            "title": "HTTP Requests by Pod and Endpoint",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}[5m])) by (kubernetes_pod_name, uri, method)",
                "legendFormat": "{{kubernetes_pod_name}} - {{method}} {{uri}}"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Response Time by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}[5m])) by (kubernetes_pod_name, le))",
                "legendFormat": "{{kubernetes_pod_name}} - 95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}[5m])) by (kubernetes_pod_name, le))",
                "legendFormat": "{{kubernetes_pod_name}} - 50th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 3,
            "title": "Error Rate by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\", status=~\"5..\"}[5m])) by (kubernetes_pod_name)",
                "legendFormat": "{{kubernetes_pod_name}} - 5xx errors"
              },
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\", status=~\"4..\"}[5m])) by (kubernetes_pod_name)",
                "legendFormat": "{{kubernetes_pod_name}} - 4xx errors"
              }
            ],
            "yAxes": [
              {
                "label": "Errors/sec"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "JVM Memory by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "jvm_memory_used_bytes{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}",
                "legendFormat": "{{kubernetes_pod_name}} - {{area}} {{id}}"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 5,
            "title": "Database Connections by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "hikaricp_connections_active{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}",
                "legendFormat": "{{kubernetes_pod_name}} - Active"
              },
              {
                "expr": "hikaricp_connections_idle{kubernetes_namespace=\"$namespace\", kubernetes_pod_name=~\"$pod\"}",
                "legendFormat": "{{kubernetes_pod_name}} - Idle"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      }
    }

  request-tracing-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Request Tracing and Analysis",
        "tags": ["requests", "tracing", "analysis"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Top Endpoints by Request Count",
            "type": "table",
            "targets": [
              {
                "expr": "topk(10, sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\"}[5m])) by (uri, method))",
                "format": "table",
                "instant": true
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Slowest Endpoints",
            "type": "table",
            "targets": [
              {
                "expr": "topk(10, histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{kubernetes_namespace=\"devops-app\"}[5m])) by (uri, method, le)))",
                "format": "table",
                "instant": true
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Request Volume Heatmap",
            "type": "heatmap",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\"}[5m])) by (uri)",
                "legendFormat": "{{uri}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Response Time Distribution",
            "type": "heatmap",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_bucket{kubernetes_namespace=\"devops-app\"}[5m])) by (le)",
                "format": "heatmap",
                "legendFormat": "{{le}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 5,
            "title": "Request Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\", status!~\"5..\"}[5m])) / sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\"}[5m])) * 100",
                "legendFormat": "Success Rate %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "thresholds": {
                  "steps": [
                    {
                      "color": "red",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 95
                    },
                    {
                      "color": "green",
                      "value": 99
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 0,
              "y": 24
            }
          },
          {
            "id": 6,
            "title": "Average Response Time",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_sum{kubernetes_namespace=\"devops-app\"}[5m])) / sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\"}[5m]))",
                "legendFormat": "Avg Response Time"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "thresholds": {
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 0.5
                    },
                    {
                      "color": "red",
                      "value": 1
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 6,
              "y": 24
            }
          },
          {
            "id": 7,
            "title": "Requests per Second",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(http_server_requests_seconds_count{kubernetes_namespace=\"devops-app\"}[5m]))",
                "legendFormat": "RPS"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps"
              }
            },
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 12,
              "y": 24
            }
          },
          {
            "id": 8,
            "title": "Active Database Connections",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(hikaricp_connections_active{kubernetes_namespace=\"devops-app\"})",
                "legendFormat": "Active Connections"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 18,
              "y": 24
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      }
    }

  infrastructure-deep-dive.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Infrastructure Deep Dive",
        "tags": ["kubernetes", "infrastructure", "deep-dive"],
        "timezone": "browser",
        "templating": {
          "list": [
            {
              "name": "node",
              "type": "query",
              "query": "label_values(kube_node_info, node)",
              "current": {
                "value": "All"
              },
              "includeAll": true
            }
          ]
        },
        "panels": [
          {
            "id": 1,
            "title": "Node CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\", instance=~\"$node\"}[5m])) by (instance) * 100)",
                "legendFormat": "{{instance}}"
              }
            ],
            "yAxes": [
              {
                "label": "CPU %",
                "min": 0,
                "max": 100
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Node Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "100 * (1 - ((node_memory_MemAvailable_bytes{instance=~\"$node\"} or node_memory_MemFree_bytes{instance=~\"$node\"}) / node_memory_MemTotal_bytes{instance=~\"$node\"}))",
                "legendFormat": "{{instance}}"
              }
            ],
            "yAxes": [
              {
                "label": "Memory %",
                "min": 0,
                "max": 100
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Disk Usage by Node",
            "type": "graph",
            "targets": [
              {
                "expr": "100 - ((node_filesystem_avail_bytes{instance=~\"$node\", mountpoint=\"/\"} / node_filesystem_size_bytes{instance=~\"$node\", mountpoint=\"/\"}) * 100)",
                "legendFormat": "{{instance}}"
              }
            ],
            "yAxes": [
              {
                "label": "Disk %",
                "min": 0,
                "max": 100
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Network Traffic by Node",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(node_network_receive_bytes_total{instance=~\"$node\", device!=\"lo\"}[5m])",
                "legendFormat": "{{instance}} - RX"
              },
              {
                "expr": "rate(node_network_transmit_bytes_total{instance=~\"$node\", device!=\"lo\"}[5m])",
                "legendFormat": "{{instance}} - TX"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes/sec"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "Pod Resource Requests vs Limits",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(kube_pod_container_resource_requests{resource=\"cpu\", namespace=\"devops-app\"}) by (pod)",
                "legendFormat": "{{pod}} - CPU Requests"
              },
              {
                "expr": "sum(kube_pod_container_resource_limits{resource=\"cpu\", namespace=\"devops-app\"}) by (pod)",
                "legendFormat": "{{pod}} - CPU Limits"
              }
            ],
            "yAxes": [
              {
                "label": "CPU cores"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 6,
            "title": "Pod Memory Requests vs Limits",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(kube_pod_container_resource_requests{resource=\"memory\", namespace=\"devops-app\"}) by (pod)",
                "legendFormat": "{{pod}} - Memory Requests"
              },
              {
                "expr": "sum(kube_pod_container_resource_limits{resource=\"memory\", namespace=\"devops-app\"}) by (pod)",
                "legendFormat": "{{pod}} - Memory Limits"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }